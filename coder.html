<!DOCTYPE html>
<html lang="id"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengetik Kode Alami - Ditingkatkan (Highlight.js)</title> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css" id="hljs-theme-main">
    <style>
        /* --- CSS dari file coder.html asli, dengan penyesuaian minimal --- */
        body {
            font-family: "Segoe UI", "Consolas", "Monaco", "Andale Mono", "Ubuntu Mono", monospace; /* Monospaced font for code */
            line-height: 1.6;
            max-width: 900px; /* Wider for code */
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            color: #212529;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #chat-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        h2 {
            color: #2b2d42;
            margin-top: 0;
            padding-bottom: 12px;
            border-bottom: 1px solid #edf2f4;
            transition: color 0.3s ease, border-color 0.3s ease;
            font-size: 24px;
        }
         #response {
            min-height: 300px; /* Taller for code */
            max-height: 600px; /* Max height for code */
            border: 1px solid #e9ecef;
            padding: 20px;
            margin-bottom: 20px; /* Margin bawah sebelum dropdowns */
            border-radius: 10px;
            background-color: #f8fafc;
            font-size: 16px; /* Smaller font for code */
            overflow-y: auto;
            line-height: 1.5; /* Tighter line height for code */
            flex-grow: 1;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            /* Highlight.js akan menangani warna syntax */
        }

        /* Style untuk elemen PRE dan CODE di dalam #response */
        /* Highlight.js menambahkan class "hljs" ke tag code */
        #response pre {
            margin: 0; /* Hapus margin default dari pre */
            padding: 0; /* Hapus padding default dari pre */
            background: none; /* Hapus background default dari pre */
        }

         #response code.hljs { /* Pastikan Highlight.js menambahkan class hljs */
            display: block; /* Pastikan code berperilaku seperti block untuk pre-wrap */
            padding: 0; /* Hapus padding default dari code */
            background: none; /* Hapus background default dari code */
            white-space: pre-wrap; /* Pertahankan whitespace dan newlines */
             word-wrap: break-word; /* Wrap long lines */
            box-sizing: border-box; /* Sertakan padding dalam total lebar/tinggi */
             /* Warna teks default jika Highlight.js tidak menerapkan gaya (misalnya, plain text) */
             /* Warna ini akan ditimpa oleh tema HLJS */
             color: #212529;
        }


        /* --- Styling untuk area input dan tombol dari file coder.html asli --- */
        #user-input {
            width: 100%;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            resize: vertical;
            min-height: 150px; /* Taller input */
            font-family: "Consolas", "Monaco", "Andale Mono", "Ubuntu Mono", monospace; /* Monospaced font */
            transition: border 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        #user-input:focus {
            border-color: #4361ee;
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        button {
            background-color: #4361ee;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            font-weight: 500;
            flex-grow: 1;
            text-align: center;
        }
        button:hover:not(:disabled) {
            background-color: #3a56d4;
            transform: translateY(-1px);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

         button#stop-button {
            background-color: #e53935;
        }
         button#stop-button:hover:not(:disabled) {
            background-color: #c62828;
         }

         button#pause-resume-button {
             background-color: #ffb300;
         }
         button#pause-resume-button:hover:not(:disabled) {
             background-color: #ffa000;
         }
        /* --- Akhir Styling area input dan tombol dari file coder.html asli --- */


        .cursor {
            display: inline-block;
            width: 7px;
            height: 1em; /* Cursor height relative to font size */
            background-color: #2b2d42;
            animation: blink 1.1s infinite;
            vertical-align: text-bottom; /* Align cursor better with text */
            margin-left: 2px;
            opacity: 0.8;
        }
        @keyframes blink {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.2; }
        }

        /* Menghapus styling language-indicator karena hanya satu indikator yang digunakan */
        /* .language-indicator { ... } */

        .typing-indicator {
            font-size: 13px;
            color: #6c757d;
            margin-top: 8px; /* Margin di atas typing indicator */
            margin-bottom: 12px; /* Margin di bawah typing indicator */
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .typing-indicator::before {
            content: "ðŸ¤–"; /* Robot/typing icon */
            margin-right: 6px;
            font-style: normal;
        }
        .typing-indicator.visible {
            opacity: 1;
        }

        /* Progress Bar Styling */
        #progress-bar-container {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: #4361ee;
            transition: width 0.1s ease-out, background-color 0.3s ease;
        }

        /* Config Toggle Button Styling (Sticky in corner) */
        #config-toggle-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #4361ee;
            color: white;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 1000;
        }
        #config-toggle-button:hover {
            background-color: #3a56d4;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
         #config-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
         }


        /* Modal Backdrop */
        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 990;
            display: none;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
         #modal-backdrop.visible {
             display: block;
             opacity: 1;
         }


        /* Config Popup Styling (Centered Modal - Wider Rectangle, Minimalist Scroll) dari coder.html asli */
        #config-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 450px; /* Width adjusted for a more stacked look */
            max-width: 95%; /* Ensure it doesn't exceed screen width */
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            padding: 30px;
            display: flex; /* Always flex */
            flex-direction: column;
            z-index: 999;
            /* --- Re-enabled scrollbar with minimalist styling --- */
            overflow-y: auto;
            overflow-x: hidden; /* Hide horizontal scroll */
            /* --- Scrollbar Styling --- */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #adb5bd #f1f1f1; /* Firefox */
            /* --- */

            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0; /* Start hidden */
            pointer-events: none; /* Disable interaction when hidden */

            box-sizing: border-box;
            max-height: 95vh; /* Adjusted max-height for responsiveness */
            position: fixed;
            z-index: 1000;
        }
         #config-popup.visible {
            opacity: 1; /* Make visible */
            pointer-events: auto; /* Enable interaction when visible */
            transform: translate(-50%, -50%);
        }

        /* Webkit (Chrome, Safari) scrollbar styling */
        #config-popup::-webkit-scrollbar {
            width: 6px;
        }
        #config-popup::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #config-popup::-webkit-scrollbar-thumb {
            background: #adb5bd;
            border-radius: 10px;
        }
        #config-popup::-webkit-scrollbar-thumb:hover {
            background: #9ca3aa;
        }
        /* --- */

        #config-popup h3 { /* Styling sub-judul di popup */
            margin-top: 0;
            margin-bottom: 25px;
            color: #2b2d42;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
            font-size: 20px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        #config-popup h4 { /* Styling sub-judul di popup */
             font-size: 16px;
             margin-top: 15px;
             margin-bottom: 10px;
             color: #343a40;
         }

        /* Layout for config items within the popup - Flex container for vertical stacking of rows */
        #code-element-configs {
             display: flex;
             flex-direction: column; /* Stack rows vertically */
             gap: 10px; /* Space between rows */
             margin-bottom: 20px;
             padding-bottom: 10px;
        }

        /* Style for each code element config row (acts as a block) */
        #code-element-configs > div {
            display: flex;
            flex-direction: column; /* Stack elements vertically within each block */
            align-items: flex-start; /* Align items to the start */
            gap: 8px; /* Space between elements within a block (label, speed group, pause group) */
            background-color: #f2f2f2;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            width: 100%; /* Take full width of the popup */
            box-sizing: border-box;
        }

         /* Style for the Code Element Name Label */
         #code-element-configs > div > label:first-child {
             flex: unset;
             margin-bottom: 5px;
             font-size: 15px;
             color: #343a40;
             white-space: normal;
             overflow: visible;
             text-overflow: clip;
             font-weight: 600;
         }

         /* Container for Base Speed inputs */
         .speed-input-group {
             display: flex;
             align-items: center;
             gap: 8px;
             flex-grow: 0;
             flex-basis: auto;
             width: 100%;
             justify-content: space-between;
         }
         /* Container for Pause Multiplier inputs */
          .pause-input-group {
             display: flex;
             align-items: center;
             gap: 8px;
             flex-grow: 0;
             flex-basis: auto;
             width: 100%;
             justify-content: space-between;
             margin-top: 5px;
         }


        .speed-input-group label,
        .pause-input-group label {
            margin-bottom: 0;
            font-size: 14px;
            color: #555;
            flex-shrink: 0;
             white-space: nowrap;
        }

        #code-element-configs input[type="number"] { /* Changed ID */
            flex: 0 0 50px; /* Input width */
            padding: 5px 8px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
             background-color: #ffffff;
             color: #212121;
             transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
             box-sizing: border-box;
             text-align: center;
        }
         #code-element-configs input[type="number"]:focus { /* Changed ID */
              border-color: #4361ee;
              box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
              outline: none;
         }

        /* Description text styling */
         #config-popup p {
             font-size: 12px;
             color: #6c757d;
             margin-top: 0;
             margin-bottom: 20px;
             line-height: 1.4;
         }

         /* Dark Mode Toggle styling (within popup) */
         #config-popup .dark-mode-toggle {
             margin-top: 20px;
             padding-top: 20px;
             border-top: 1px solid #e0e0e0;
             text-align: center;
             display: flex;
             justify-content: center;
             align-items: center;
             gap: 10px;
         }

          #config-popup .dark-mode-toggle button {
             padding: 10px 20px;
             font-size: 15px;
             background-color: #adb5bd;
             color: #212121;
             flex-grow: 0;
             width: auto;
             border-radius: 8px;
             font-weight: normal;
             transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
             display: flex;
             align-items: center;
             justify-content: center;
          }
          #config-popup .dark-mode-toggle button:hover:not(:disabled) {
              background-color: #9ca3aa;
          }
           #config-popup .dark-mode-toggle button i {
               margin-right: 8px;
           }

           /* Close Button Styling */
           #config-popup .close-button {
               position: absolute;
               top: 15px;
               right: 15px;
               background: none;
               border: none;
               font-size: 20px;
               color: #6c757d;
               cursor: pointer;
               padding: 5px;
               line-height: 1;
               transition: color 0.2s ease;
               z-index: 10;
           }
            #config-popup .close-button:hover {
                color: #212121; /* Darker on hover */
            }

        /* --- Styling untuk Language dan Theme Selectors (DI LUAR POPUP) --- */
        .controls-container {
            display: flex;
            gap: 20px; /* Space between language and theme selectors */
            margin-bottom: 15px; /* Margin bawah sebelum typing indicator */
            flex-wrap: wrap; /* Allow wrapping on small screens */
            align-items: flex-end; /* Align items to the bottom */
        }

        .selection-group {
            flex: 1; /* Take equal space */
            min-width: 150px; /* Minimum width before wrapping */
            display: flex;
            flex-direction: column;
        }

        .selection-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #343a40;
            font-size: 14px;
        }

        .selection-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background-color: #ffffff;
            color: #212121;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
        }

        .selection-group select:focus {
            border-color: #4361ee;
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }
        /* --- Akhir Styling untuk Language dan Theme Selectors (DI LUAR POPUP) --- */


        /* Dark Mode Styling for Main Page */
        body.dark-mode {
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        body.dark-mode #chat-container {
            background-color: #2a2a4a;
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }
         body.dark-mode h2 {
            color: #9b86f0;
            border-color: #4f3a8c;
        }
         body.dark-mode #response {
            background-color: #3a3a5a;
            border-color: #4f3a8c;
            color: #e0e0e0;
            /* Highlight.js dark mode colors will override these defaults */
        }

         body.dark-mode #response code {
             color: #e0e0e0; /* Warna teks default di dark mode */
         }

         /* Dark mode untuk elemen select bahasa/tema di luar popup */
         body.dark-mode .selection-group label {
             color: #e0e0e0;
         }
         body.dark-mode .selection-group select {
             background-color: #2a2a4a;
             border-color: #4f3a8c;
             color: #e0e0e0;
         }
         body.dark-mode .selection-group select:focus {
             border-color: #8a6fef;
             box-shadow: 0 0 0 2px rgba(138, 111, 239, 0.3);
         }


        body.dark-mode #user-input {
            background-color: #2a2a4a;
            border-color: #4f3a8c;
            color: #e0e0e0;
        }
         body.dark-mode #user-input::placeholder {
            color: #b0b0b0;
         }
         body.dark-mode #user-input:focus {
            border-color: #8a6fef;
            box-shadow: 0 0 0 3px rgba(138, 111, 239, 0.3);
        }
         body.dark-mode .cursor {
            background-color: #8a6fef;
        }
        body.dark-mode .language-indicator,
        body.dark-mode .typing-indicator {
            color: #b0b0b0;
        }
        body.dark-mode #progress-bar-container {
            background-color: #4f3a8c;
         }
         body.dark-mode #progress-bar {
             background-color: #8a6fef;
         }
         body.dark-mode .button-group button:not(:disabled) {
             background-color: #8a6fef;
             color: #ffffff;
         }
          body.dark-mode .button-group button:not(:disabled):hover {
             background-color: #7b5ae9;
         }
         body.dark-mode button#stop-button:not(:disabled) {
             background-color: #e76f51;
         }
         body.dark-mode button#stop-button:not(:disabled):hover {
             background-color: #d65f42;
         }
         body.dark-mode button#pause-resume-button:not(:disabled) {
             background-color: #fca311;
             color: #212121;
         }
          body.dark-mode button#pause-resume-button:not(:disabled):hover {
              background-color: #eb9300;
          }
         body.dark-mode button:disabled {
             background-color: #555555;
             color: #b0b0b0;
         }

         /* Dark Mode Toggle Button Main Styling (inside popup) */
         body.dark-mode #config-popup .dark-mode-toggle button { /* Added #config-popup */
            background-color: #fca311;
            color: #212121;
         }
          body.dark-mode #config-popup .dark-mode-toggle button:hover:not(:disabled) { /* Added #config-popup */
            background-color: #eb9300;
         }


         /* Dark Mode Styling for Popup and Backdrop */
         body.dark-mode #config-toggle-button {
            background-color: #8a6fef;
            color: #ffffff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
         body.dark-mode #config-toggle-button:hover {
            background-color: #7b5ae9;
         }

         body.dark-mode #modal-backdrop {
             background-color: rgba(0, 0, 0, 0.85);
             backdrop-filter: blur(5px);
         }

        body.dark-mode #config-popup {
            background-color: #2a2a4a;
            box-shadow: 0 12px 30px rgba(0,0,0,0.6);
            scrollbar-color: #4f3a8c #2a2a4a; /* Firefox dark mode scrollbar */
        }
         body.dark-mode #config-popup::-webkit-scrollbar-track {
            background: #2a2a4a; /* Webkit dark mode scrollbar track */
         }
         body.dark-mode #config-popup::-webkit-scrollbar-thumb {
            background: #8a6fef; /* Webkit dark mode scrollbar thumb */
         }
         body.dark-mode #config-popup::-webkit-scrollbar-thumb:hover {
             background: #7b5ae9;
         }

         body.dark-mode #config-popup h3 {
            color: #9b86f0;
            border-color: #4f3a8c;
        }
         body.dark-mode #code-element-configs > div { /* Changed ID */
             background-color: #3a3a5a;
             border-color: #4f3a8c;
         }
         body.dark-mode #code-element-configs label { /* Changed ID */
             color: #e0e0e0;
         }
          body.dark-mode .speed-input-group label,
          body.dark-mode .pause-input-group label {
              color: #b0b0b0;
          }
          body.dark-mode #code-element-configs input[type="number"] { /* Changed ID */
             background-color: #2a2a4a;
             border-color: #555;
             color: #e0e0e0;
         }
         body.dark-mode #config-popup p {
             color: #b0b0b0;
         }
         body.dark-mode #config-popup .dark-mode-toggle {
             border-color: #4f3a8c;
         }


         /* Dark Mode Close Button Style */
         body.dark-mode #config-popup .close-button {
             color: #b0b0b0;
         }
         body.dark-mode #config-popup .close-button:hover {
            color: #e0e0e0;
         }


        /* Responsive adjustments */
        /* Styles for wider screens (desktop/tablet) */
        @media (min-width: 501px) { /* Apply these styles for screens wider than 500px */
             #config-popup {
                width: 450px; /* Consistent width for wider screens */
                max-width: 95%;
                padding: 25px;
                max-height: 90vh;
             }
              #config-popup h3 {
                 font-size: 18px;
                 margin-bottom: 20px;
                 padding-bottom: 10px;
             }

             #code-element-configs { /* Changed ID */
                 gap: 10px;
                 margin-bottom: 15px;
                 flex-direction: column; /* Stack rows */
             }

              #code-element-configs > div { /* Changed ID */
                 padding: 12px 15px;
                 gap: 6px; /* Adjusted gap */
                 flex-direction: column; /* Stack elements within block */
              }

               #code-element-configs > div > label:first-child { /* Changed ID */
                   font-size: 14px;
                   margin-bottom: 4px;
               }

              .speed-input-group,
              .pause-input-group {
                  gap: 6px; /* Adjusted gap */
                  flex-direction: row; /* Elements in row */
                  justify-content: space-between; /* Space between label/input */
              }

              .speed-input-group label,
              .pause-input-group label {
                  font-size: 13px;
                  white-space: nowrap;
                  flex-shrink: 0;
              }

              #code-element-configs input[type="number"] { /* Changed ID */
                 width: 50px;
                 font-size: 13px;
                 padding: 4px 6px;
                 flex: unset;
              }
               #config-popup p {
                   font-size: 11px;
                   margin-bottom: 15px;
               }
               #config-popup .dark-mode-toggle {
                   margin-top: 15px;
                   padding-top: 15px;
                   gap: 8px;
               }
               #config-popup .dark-mode-toggle button {
                   width: auto;
                   font-size: 14px;
               }
                #config-popup .close-button {
                    top: 10px;
                    right: 10px;
                    font-size: 18px;
                }
                 .controls-container { /* Adjustments for wider screens */
                     flex-direction: row; /* Arrange dropdowns in a row */
                     align-items: flex-end;
                }
                 .selection-group { /* Adjustments for wider screens */
                     flex-grow: 1;
                     min-width: 150px;
                     flex-direction: column;
                 }
        }

         /* Styles for smaller screens (mobile) */
         @media (max-width: 500px) {
            #config-popup {
                 width: calc(100% - 30px);
                 padding: 15px;
                 max-height: 95vh;
            }
             #config-popup h3 {
                font-size: 17px;
                 margin-bottom: 15px;
                 padding-bottom: 10px;
             }

              #code-element-configs { /* Changed ID */
                 gap: 8px;
                 margin-bottom: 15px;
                 flex-direction: column;
             }
              #code-element-configs > div { /* Changed ID */
                  padding: 10px 12px;
                  gap: 5px;
                  flex-direction: column;
              }

               #code-element-configs > div > label:first-child { /* Changed ID */
                    font-size: 14px;
                    margin-bottom: 3px;
               }

               .speed-input-group,
               .pause-input-group {
                   gap: 5px;
                   flex-direction: row;
                   justify-content: space-between;
               }

               .speed-input-group label,
               .pause-input-group label {
                   font-size: 12px;
                   white-space: nowrap;
                   flex-shrink: 0;
               }

                #code-element-configs input[type="number"] { /* Changed ID */
                   width: 45px;
                   font-size: 12px;
                   padding: 3px 5px;
                   flex: unset;
                }
                #config-popup p {
                   font-size: 10px;
                   margin-bottom: 10px;
                }
                 #config-popup .dark-mode-toggle {
                     margin-top: 10px;
                     padding-top: 10px;
                     gap: 6px;
                 }
                  #config-popup .dark-mode-toggle button {
                      font-size: 12px;
                      padding: 8px 15px;
                      width: 100%;
                  }
                   #config-popup .dark-mode-toggle button i {
                      margin-right: 5px;
                   }
                   #config-popup .close-button {
                       top: 8px;
                       right: 8px;
                       font-size: 16px;
                   }
         }

          @media (max-width: 380px) { /* Adjustments for very small screens */
             #config-toggle-button {
                bottom: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
             #config-popup {
                 padding: 8px;
            }
              #config-popup h3 {
                 font-size: 15px;
                 margin-bottom: 8px;
                 padding-bottom: 6px;
             }
             #code-element-configs { /* Changed ID */
                 gap: 6px;
                 margin-bottom: 8px;
             }
              #code-element-configs > div { /* Changed ID */
                   padding: 8px 10px;
                   gap: 4px;
              }

               #code-element-configs > div > label:first-child { /* Changed ID */
                   font-size: 12px;
                    margin-bottom: 2px;
               }


               .speed-input-group,
               .pause-input-group {
                   gap: 4px;
                   flex-direction: row; /* Keep in row */
                   justify-content: space-between;
               }

               .speed-input-group label,
               .pause-input-group label {
                   font-size: 11px;
                   white-space: nowrap;
               }

                #code-element-configs input[type="number"] { /* Changed ID */
                   width: 40px;
                   font-size: 11px;
                   padding: 3px 5px;
                }
                #config-popup p {
                   font-size: 9px;
                   margin-bottom: 8px;
                }
                 #config-popup .dark-mode-toggle {
                     margin-top: 8px;
                     padding-top: 8px;
                     gap: 4px;
                 }
                  #config-popup .dark-mode-toggle button {
                      font-size: 11px;
                      padding: 6px 12px;
                  }
                   #config-popup .dark-mode-toggle button i {
                      margin-right: 4px;
                   }
                   #config-popup .close-button {
                        top: 5px;
                        right: 5px;
                        font-size: 14px;
                   }
         }
    </style>
</head>
<body>
    <div id="chat-container">
        <h2>Pengetik Kode Alami - Ditingkatkan (Highlight.js)</h2> <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>

        <div id="response">
            <pre><code class="hljs"></code></pre> </div>

        <div class="controls-container">
            <div class="selection-group">
                <label for="language-select">Pilih Jenis Kode:</label> <select id="language-select"></select> </div>
            <div class="selection-group">
                <label for="theme-select">Pilih Tema:</label> <select id="theme-select"></select> </div>
        </div>
         <div id="typing-status" class="typing-indicator">Mengetik kode...</div> <textarea id="user-input" placeholder="Tempel kode Anda di sini... (Mendukung berbagai bahasa pemrograman)" spellcheck="false"></textarea> <div class="button-group">
             <button onclick="startTypingCode()">Mulai Mengetik Kode</button> <button id="pause-resume-button" onclick="togglePauseResumeCode()" disabled>Jeda Pengetikan</button> <button id="stop-button" onclick="stopTypingCode()" disabled>Hentikan Pengetikan</button> </div>

        <button id="config-toggle-button" onclick="toggleConfigPopup()">
            <i class="fas fa-cog"></i> </button> <div id="modal-backdrop"></div>

        <div id="config-popup">
             <button class="close-button" onclick="toggleConfigPopup()">
                <i class="fas fa-times"></i> </button> <h3>Pengaturan</h3> <h4>Kecepatan Pengetikan (ms)</h4> <div id="code-element-configs"> </div>
            <p style="font-size: 12px; color: #6c757d; margin-top: 0; margin-bottom: 15px; line-height: 1.4;">Sesuaikan nilai-nilai ini untuk mengubah kecepatan pengetikan per jenis elemen kode. Kecepatan Dasar adalah jeda per karakter. Pengali Jeda memengaruhi jeda setelah elemen.</p> <h4>Tampilan Website</h4> <div class="dark-mode-toggle">
                <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Mode Gelap</button> </div>
             <p style="font-size: 12px; color: #6c757d; margin-top: 10px; line-height: 1.4;">Mengubah tema gelap/terang untuk elemen website, tidak memengaruhi warna syntax kode.</p> </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script>
        // Daftar tema Highlight.js dan URL CSS mereka
        const HLJS_THEMES = [
            { name: 'Default', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css' },
            { name: 'GitHub', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css' },
            { name: 'Atom One Dark', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-dark.min.css' },
            { name: 'Monokai', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/monokai.min.css' },
            { name: 'Dracula', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/dracula.min.css' },
            { name: 'Solarized Dark', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/solarized-dark.min.css' },
            { name: 'Solarized Light', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/solarized-light.min.css' },
            { name: 'Purebasic', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/purebasic.min.css' },
             { name: 'VS', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/vs.min.css' },
             { name: 'VS Dark', url: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/vs-dark.min.css' }
            // Tambahkan lebih banyak tema di sini
        ];

        // Kecepatan pengetikan konfigurasi untuk elemen kode yang berbeda (Mudah disesuaikan di sini)
        // Catatan: Dengan pendekatan Highlight Sekali, logika delay akan menggunakan karakter dari teks asli.
        const CODE_ELEMENT_CONFIGS = {
            KEYWORD: { name: 'Kata Kunci', baseSpeed: 40, pauseMultiplier: 1.0 }, // Indonesian
            OPERATOR: { name: 'Operator', baseSpeed: 60, pauseMultiplier: 1.0 },
            STRING: { name: 'String', baseSpeed: 20, pauseMultiplier: 1.2 }, // Ketik karakter dalam string relatif cepat, jeda kecil setelah
            COMMENT: { name: 'Komentar', baseSpeed: 15, pauseMultiplier: 1.1 }, // Indonesian
            NUMBER: { name: 'Angka', baseSpeed: 35, pauseMultiplier: 1.0 }, // Indonesian
            PUNCTUATION: { name: 'Tanda Baca', baseSpeed: 70, pauseMultiplier: 1.3 }, // Indonesian // Jeda lebih lama setelah tanda baca
            WHITESPACE: { name: 'Spasi', baseSpeed: 10, pauseMultiplier: 0.5 }, // Indonesian // Spasi/tab cepat, jeda minimal setelah
            NEWLINE: { name: 'Baris Baru', baseSpeed: 0, pauseMultiplier: 1.5 }, // Indonesian // Jeda setelah baris baru, tanpa kecepatan ketik
            INDENTATION: { name: 'Inden', baseSpeed: 5, pauseMultiplier: 0.1 }, // Indonesian // Mengetik spasi/tab untuk indentasi, hampir tanpa jeda
            VARIABLE: { name: 'Variabel/Nama', baseSpeed: 30, pauseMultiplier: 1.0 }, // Indonesian // Default untuk kata yang tidak cocok
            LITERAL: { name: 'Literal', baseSpeed: 35, pauseMultiplier: 1.0 }, // true, false, null, undefined
            OTHER: { name: 'Lainnya', baseSpeed: 30, pauseMultiplier: 1.0 } // Indonesian // Karakter tunggal lainnya
        };

        // Mapping Highlight.js classes to internal CODE_ELEMENT_CONFIGS types
        const HLJS_CLASS_TO_CONFIG_TYPE = {
             'hljs-keyword': 'KEYWORD',
             'hljs-operator': 'OPERATOR',
             'hljs-string': 'STRING',
             'hljs-comment': 'COMMENT',
             'hljs-number': 'NUMBER',
             'hljs-punctuation': 'PUNCTUATION',
             'hljs-variable': 'VARIABLE',
             'hljs-literal': 'LITERAL',
             'hljs-built_in': 'VARIABLE', // built-in functions/objects often typed like variables
             'hljs-function': 'VARIABLE', // function names often typed like variables
             'hljs-title': 'VARIABLE', // Titles in some contexts
             // Tambahkan mapping lain sesuai kebutuhan berdasarkan HLJS class
             // Fallback ke 'OTHER' jika kelas tidak terdaftar
        };


        // Typing state management
        let isTyping = false;
        let isPaused = false;
        let currentTypingTimeout = null;
        let totalCodeLength = 0; // Total panjang kode asli (plain text)

        // Variabel untuk menyimpan progres pengetikan untuk pause/resume
        let originalCodeText = ''; // Simpan teks kode asli (plain text)
        let fullHighlightedHtml = ''; // Simpan string HTML yang sudah di-highlight penuh
        let currentCharIndex = 0; // Indeks karakter pada kode asli (plain text) yang sudah ditampilkan
        let currentHtmlIndex = 0; // Indeks karakter pada fullHighlightedHtml yang sedang diproses


        const responseElement = document.getElementById('response');
        // Dapatkan elemen code di dalam response
        const codeElement = responseElement.querySelector('pre code');

        const typingIndicator = document.getElementById('typing-status');
        const userInputElement = document.getElementById('user-input');
        const stopButton = document.getElementById('stop-button');
        const sendButton = document.querySelector('.button-group button:not(#stop-button):not(#pause-resume-button)');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const progressBar = document.getElementById('progress-bar');
        // Dapatkan elemen select bahasa dan tema syntax
        const languageSelectElement = document.getElementById('language-select');
        const themeSelectElement = document.getElementById('theme-select');
        // Dapatkan elemen link stylesheet Highlight.js utama
        const hljsThemeLinkElement = document.getElementById('hljs-theme-main');


        const codeElementConfigsDiv = document.getElementById('code-element-configs'); // Dapatkan div konfigurasi
        const configPopup = document.getElementById('config-popup'); // Dapatkan elemen popup
        const modalBackdrop = document.getElementById('modal-backdrop'); // Dapatkan elemen backdrop

        // Tombol toggle dark mode (berada di dalam popup sekarang)
        const darkModeToggleButton = document.querySelector('#config-popup .dark-mode-toggle button');


        // Status tombol awal
        stopButton.disabled = true;
        pauseResumeButton.disabled = true;

        // --- Fungsi Terkait Tema Syntax Highlight.js ---

        // Fungsi untuk mengisi dropdown tema syntax
        function populateThemeSelect() {
            themeSelectElement.innerHTML = ''; // Bersihkan opsi yang sudah ada
            HLJS_THEMES.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.url;
                option.textContent = theme.name;
                themeSelectElement.appendChild(option);
            });
        }

        // Fungsi untuk menerapkan tema Highlight.js yang dipilih (HANYA TEMA SYNTAX)
        function applySelectedHljsTheme(themeUrl) {
            if (hljsThemeLinkElement) {
                hljsThemeLinkElement.href = themeUrl; // Ubah href link stylesheet tema utama
                 localStorage.setItem('selectedHljsThemeUrl', themeUrl); // Simpan URL tema HLJS

                 // Setelah mengganti tema, highlight ulang konten yang ada jika sedang tidak mengetik
                 // Jika sedang mengetik atau dijeda, ini akan ditangani oleh logic pengetikan/resume
                 if (codeElement.textContent.trim() !== '' && !isTyping && !isPaused) {
                     // Re-highlight teks biasa yang ada di elemen code
                      const plainTextContent = codeElement.textContent.replace(/<span class="cursor"><\/span>/g, '');
                       // Gunakan bahasa yang dipilih (termasuk auto-detect dengan hljs.highlightAuto)
                      const selectedLanguage = languageSelectElement.value;
                      let highlightedResult;
                       if (selectedLanguage === '') {
                           highlightedResult = hljs.highlightAuto(plainTextContent);
                           // Pastikan class bahasa yang terdeteksi ditambahkan ke codeElement
                            codeElement.className = `hljs ${highlightedResult.language ? 'language-' + highlightedResult.language : ''}`;
                       } else {
                           highlightedResult = hljs.highlight(plainTextContent, {language: selectedLanguage});
                            // Pastikan class bahasa yang dipilih ditambahkan ke codeElement
                            codeElement.className = `hljs language-${selectedLanguage}`;
                       }

                      codeElement.innerHTML = highlightedResult.value + '<span class="cursor"></span>'; // Setel innerHTML dengan hasil highlight + kursor

                 } else if (isPaused && fullHighlightedHtml) {
                     // Jika dijeda, dan kita punya HTML yang sudah di-highlight penuh (dari bahasa/tema sebelumnya),
                     // kita perlu menampilkan kembali bagian HTML yang sudah diketik.
                     // Gunakan substring dari fullHighlightedHtml sampai currentHtmlIndex
                     const currentlyDisplayedHtmlSnippet = fullHighlightedHtml.substring(0, currentHtmlIndex);
                     codeElement.innerHTML = currentlyDisplayedHtmlSnippet + '<span class="cursor"></span>';
                     // Tidak perlu re-highlight penuh di sini, CSS tema baru akan berlaku pada HTML yang ada
                 }

            } else {
                 console.error("Highlight.js main theme link element not found!");
            }
        }

        // Tambahkan event listener ke dropdown tema syntax
        themeSelectElement.addEventListener('change', (e) => {
            applySelectedHljsTheme(e.target.value);
        });


        // --- Akhir Fungsi Terkait Tema Syntax Highlight.js ---


        // Fungsi untuk mengisi dropdown bahasa
        function populateLanguageSelect() {
             if (typeof hljs === 'undefined') {
                 console.error('Highlight.js belum dimuat.');
                 return;
             }
            const languages = hljs.listLanguages();
            // Tambahkan opsi 'Auto-detect'
            languageSelectElement.innerHTML = '<option value="">Auto-detect</option>'; // Indonesian
            languages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = lang; // Bisa menggunakan nama yang lebih user-friendly jika tersedia di HLJS, ini pakai ID
                languageSelectElement.appendChild(option);
            });

            // Set nilai default atau yang tersimpan
             const savedLang = localStorage.getItem('selectedLanguageId');
             if (savedLang && (languages.includes(savedLang) || savedLang === '')) { // Pastikan bahasa valid atau auto-detect
                 languageSelectElement.value = savedLang;
             } else {
                 languageSelectElement.value = ''; // Default ke Auto-detect
             }
        }

        // Fungsi untuk mengisi panel konfigurasi UI untuk elemen kode
        function populateCodeElementConfigPanel() {
            codeElementConfigsDiv.innerHTML = ''; // Hapus yang sudah ada
            for (const elementType in CODE_ELEMENT_CONFIGS) {
                const config = CODE_ELEMENT_CONFIGS[elementType];
                const div = document.createElement('div');
                 // Struktur: Nama Elemen | Grup Input Kecepatan Dasar | Grup Input Pengali Jeda
                div.innerHTML = `
                    <label>${config.name}:</label>
                    <div class="speed-input-group">
                         <label for="${elementType}-baseSpeed">Kecepatan Dasar:</label> <input type="number" id="${elementType}-baseSpeed" value="${config.baseSpeed}" min="0" step="1">
                    </div>
                    <div class="pause-input-group">
                         <label for="${elementType}-pauseMultiplier">Pengali Jeda:</label> <input type="number" id="${elementType}-pauseMultiplier" value="${config.pauseMultiplier}" step="0.1" min="0.1">
                    </div>
                `;
                codeElementConfigsDiv.appendChild(div);

                // Tambahkan event listener untuk memperbarui konfigurasi saat diubah
                document.getElementById(`${elementType}-baseSpeed`).addEventListener('change', (e) => {
                    const value = parseInt(e.target.value);
                    if (!isNaN(value)) CODE_ELEMENT_CONFIGS[elementType].baseSpeed = value;
                });
                 document.getElementById(`${elementType}-pauseMultiplier`).addEventListener('change', (e) => {
                     const value = parseFloat(e.target.value);
                    if (!isNaN(value)) CODE_ELEMENT_CONFIGS[elementType].pauseMultiplier = value;
                });
            }
        }


        // Helper untuk mereset semua variabel progres dan status serta UI
        function resetProgressVariables() {
            isTyping = false;
            isPaused = false;
            if (currentTypingTimeout) {
                 clearTimeout(currentTypingTimeout);
                 currentTypingTimeout = null;
            }
            originalCodeText = ''; // Reset teks asli (plain text)
            fullHighlightedHtml = ''; // Reset HTML yang sudah di-highlight penuh
            currentCharIndex = 0; // Reset indeks karakter pada kode asli (plain text)
            currentHtmlIndex = 0; // Reset indeks pada HTML yang sudah di-highlight
            totalCodeLength = 0; // Reset total panjang kode asli

            // Reset elemen UI
            codeElement.innerHTML = ''; // Bersihkan konten elemen code (gunakan innerHTML)
             // Reset class bahasa pada elemen code (tetap hljs)
            codeElement.className = 'hljs'; // Pertahankan kelas dasar HLJS

            progressBar.style.width = '0%';
            typingIndicator.classList.remove('visible');
            typingIndicator.textContent = 'Mengetik kode...'; // Indonesian
            stopButton.disabled = true;
            pauseResumeButton.disabled = true;
            pauseResumeButton.textContent = 'Jeda Pengetikan'; // Indonesian
            sendButton.disabled = false; // Aktifkan kembali tombol Mulai
            userInputElement.value = ''; // Bersihkan input setelah mendapatkan kode
        }


        function startTypingCode() {
            const userCodeInput = userInputElement.value; // Jangan trim input kode
            if (!userCodeInput || isTyping) return;

            resetProgressVariables(); // Reset status di awal generasi baru

            originalCodeText = userCodeInput;
            totalCodeLength = originalCodeText.length;

            // Dapatkan bahasa yang dipilih dari dropdown
            const selectedLanguage = languageSelectElement.value;

            let highlightedResult;
             try {
                 if (selectedLanguage === '') {
                     // Gunakan auto-detect jika 'Auto-detect' dipilih
                     highlightedResult = hljs.highlightAuto(originalCodeText);
                     // Set class bahasa yang terdeteksi pada elemen code
                     codeElement.className = `hljs ${highlightedResult.language ? 'language-' + highlightedResult.language : ''}`;
                 } else {
                     // Gunakan bahasa spesifik jika dipilih
                     highlightedResult = hljs.highlight(originalCodeText, {language: selectedLanguage});
                     // Set class bahasa yang dipilih pada elemen code
                     codeElement.className = `hljs language-${selectedLanguage}`;
                 }
                 fullHighlightedHtml = highlightedResult.value; // Simpan HTML yang sudah di-highlight

             } catch (e) {
                 console.error("Highlight.js error during initial highlighting:", e);
                  // Fallback: Jika Highlight.js gagal, gunakan teks biasa
                 fullHighlightedHtml = escapeHTML(originalCodeText); // Escape HTML for plain text fallback
                  codeElement.className = ''; // Hapus class hljs jika fallback
             }


            // Set initial empty content
            codeElement.innerHTML = '';

            // Reset indeks untuk memulai dari awal HTML dan Plain Text
            currentHtmlIndex = 0;
            currentCharIndex = 0;


            typingIndicator.classList.add('visible');
            isTyping = true;
            isPaused = false;
            stopButton.disabled = false;
            pauseResumeButton.disabled = false;
            pauseResumeButton.textContent = 'Jeda Pengetikan'; // Indonesian
            sendButton.disabled = true; // Nonaktifkan tombol Mulai saat mengetik
            userInputElement.value = ''; // Bersihkan input setelah mendapatkan kode

            // Mulai mengetik dengan delay awal
            setTimeout(() => {
                 // Panggil typeCodeCharacter dengan indeks HTML awal
                 typeCodeCharacter();
            }, 500); // Delay awal singkat
        }

        function stopTypingCode() {
            resetProgressVariables(); // Reset penuh saat stop
        }

        function togglePauseResumeCode() {
            if (!isTyping) return;

            if (isPaused) {
                resumeTypingCode();
            } else {
                pauseTypingCode();
            }
        }

        function pauseTypingCode() {
             if (currentTypingTimeout) {
                clearTimeout(currentTypingTimeout);
                currentTypingTimeout = null;
            }
            isPaused = true;
            typingIndicator.textContent = 'Pengetikan Dijeda...'; // Indonesian
            pauseResumeButton.textContent = 'Lanjutkan Pengetikan'; // Indonesian
            // currentHtmlIndex dan currentCharIndex sudah diperbarui oleh typeCodeCharacter
        }

        function resumeTypingCode() {
             isPaused = false;
            typingIndicator.textContent = 'Mengetik kode...'; // Indonesian
            pauseResumeButton.textContent = 'Jeda Pengetikan'; // Indonesian

             // Lanjutkan mengetik dari indeks HTML dan Plain Text yang disimpan
            typeCodeCharacter();
        }

        // Helper function to get the syntax class at a specific HTML index in the fullHighlightedHtml string
        function getSyntaxClassAtHtmlIndex(htmlString, index) {
            // This is a simplified approach. A more robust solution would involve a proper HTML parser.
            // We look backwards from the index to find the most recent opening span tag and its class.

            let searchIndex = index;

            while(searchIndex >= 0) {
                 // If we hit the start of an opening span tag
                if (htmlString[searchIndex] === '<' && htmlString.substring(searchIndex, searchIndex + 5) === '<span') {
                    // Found a potential span tag start. Extract its content up to the next '>'
                    const tagEndIndex = htmlString.indexOf('>', searchIndex);
                    if (tagEndIndex !== -1) {
                        const tagContent = htmlString.substring(searchIndex, tagEndIndex + 1);
                        const classMatch = tagContent.match(/class\s*=\s*["']([^"']+)["']/);
                        if (classMatch && classMatch[1]) {
                            // Found a class attribute. Return the full class string.
                             // We assume the *last* hljs- class in the string is the most specific one
                             const classes = classMatch[1].split(/\s+/).filter(cls => cls.startsWith('hljs-'));
                             return classes.length > 0 ? classes[classes.length - 1] : null; // Return last hljs- class or null
                        }
                    }
                    // If no class found or tag malformed, keep searching backwards
                } else if (htmlString[searchIndex] === '>' && htmlString.substring(searchIndex - 7, searchIndex + 1) === '</span>') {
                    // If we hit the end of a closing span tag, we know the character at 'index' is *outside* this span.
                    // We need to skip the entire span tag we just found the end of and continue searching backwards.
                     let tagStartIndex = htmlString.lastIndexOf('<span', searchIndex);
                     if(tagStartIndex !== -1 && htmlString[tagStartIndex -1] !== '<') { // Make sure it's not part of a closing tag like <span class="...">...</span>
                          // Found the corresponding opening tag start, skip backward past it to continue search
                          searchIndex = tagStartIndex - 1;
                          continue; // Continue the while loop from the new searchIndex
                     } else {
                          // Could be a self-closing span (though rare in HLJS output) or error. Move back one step.
                          searchIndex--;
                          continue;
                     }
                } else if (htmlString[searchIndex] === '<' && htmlString.substring(searchIndex, searchIndex + 7) === '</span') {
                    // If we hit the start of a closing span tag, skip past it and continue searching backwards
                     let tagEndIndex = htmlString.indexOf('>', searchIndex);
                     if (tagEndIndex !== -1) {
                          searchIndex = tagEndIndex; // Search from the character after the closing tag
                          continue;
                     }
                }


                searchIndex--; // Move one step backwards
            }

            return null; // No span tag with a class found before the index
        }


        // Helper function to get the corresponding config type from an HLJS class
        function getConfigTypeFromHljsClass(hljsClass) {
            // Use mapping, fallback to OTHER if not found
            return HLJS_CLASS_TO_CONFIG_TYPE[hljsClass] || 'OTHER';
        }


        // Fungsi utama: Mengetik berdasarkan fullHighlightedHtml
        function typeCodeCharacter() {
             // Berhenti jika dijeda atau selesai
            if (isPaused) {
                 // currentHtmlIndex dan currentCharIndex sudah disimpan
                 return;
            }

            // Pastikan tidak melebihi panjang HTML yang sudah di-highlight
            if (currentHtmlIndex >= fullHighlightedHtml.length) {
                // Pengetikan selesai, hapus kursor final
                codeElement.innerHTML = fullHighlightedHtml; // Pastikan HTML penuh ditampilkan
                // currentCharIndex sudah di-update di bawah
                updateProgressBar();
                resetProgressVariables(); // Reset status
                return;
            }

            let char = fullHighlightedHtml[currentHtmlIndex];
            let delay = CODE_ELEMENT_CONFIGS.OTHER.baseSpeed; // Delay default

            // Logika untuk menangani tag HTML
            if (char === '<') {
                let endTagIndex = fullHighlightedHtml.indexOf('>', currentHtmlIndex);
                if (endTagIndex !== -1) {
                     // Ini tag SPAN (pembuka atau penutup)
                     currentHtmlIndex = endTagIndex + 1; // Lanjutkan setelah tag
                     // Jangan update currentCharIndex karena ini bukan karakter plain text

                    // Tambahkan jeda ekstra setelah tag penutup </span> atau baris baru
                    if (fullHighlightedHtml.substring(currentHtmlIndex - 8, currentHtmlIndex) === '</span>\n' || fullHighlightedHtml.substring(currentHtmlIndex - 7, currentHtmlIndex) === '</span>') { // Cek jika tag penutup diikuti newline atau tag penutup saja
                          // Coba dapatkan kelas dari posisi plain text terakhir *sebelum* tag penutup
                         const hljsClassBeforeTag = getSyntaxClassAtHtmlIndex(fullHighlightedHtml, currentHtmlIndex - 8); // Coba cari kelas sebelum tag penutup
                         if (hljsClassBeforeTag) {
                              const configType = getConfigTypeFromHljsClass(hljsClassBeforeTag);
                              delay = CODE_ELEMENT_CONFIGS[configType].baseSpeed * CODE_ELEMENT_CONFIGS[configType].pauseMultiplier;
                         } else {
                              delay = CODE_ELEMENT_CONFIGS.OTHER.baseSpeed * CODE_ELEMENT_CONFIGS.OTHER.pauseMultiplier;
                         }
                          // Tambahkan jeda baris baru jika ada newline
                         if (fullHighlightedHtml[currentHtmlIndex -1] === '\n') { // Cek karakter tepat sebelum htmlIndex saat ini
                             delay = Math.max(delay, CODE_ELEMENT_CONFIGS.NEWLINE.pauseMultiplier * 100);
                         }
                    } else {
                         delay = 0; // Tidak ada delay untuk 'mengetik' tag itu sendiri
                    }


                     // Atur innerHTML dengan potongan HTML sampai setelah tag
                     const currentDisplayedHtml = fullHighlightedHtml.substring(0, currentHtmlIndex);
                     codeElement.innerHTML = currentDisplayedHtml + '<span class="cursor"></span>';
                     scrollToBottom(responseElement);

                     // Langsung panggil typeCodeCharacter berikutnya dengan delay yang ditentukan (bisa 0)
                     currentTypingTimeout = setTimeout(() => { typeCodeCharacter(); }, delay);
                     return; // Keluar dari panggilan saat ini setelah memproses tag

                } else {
                    // Tag tidak lengkap, mungkin akhir string atau error, perlakukan sebagai karakter biasa
                     delay = CODE_ELEMENT_CONFIGS.OTHER.baseSpeed;
                     currentHtmlIndex++; // Maju satu karakter di HTML
                     currentCharIndex++; // Maju satu karakter di plain text
                }
            } else {
                // Karakter plain text
                 // Tentukan delay berdasarkan syntax element (class span) dari karakter ini
                 // Gunakan getSyntaxClassAtHtmlIndex pada currentHtmlIndex
                 const hljsClass = getSyntaxClassAtHtmlIndex(fullHighlightedHtml, currentHtmlIndex);
                 if (hljsClass) {
                     const configType = getConfigTypeFromHljsClass(hljsClass);
                      delay = CODE_ELEMENT_CONFIGS[configType].baseSpeed;
                 } else {
                      // Default delay jika tidak dalam span syntax
                     delay = CODE_ELEMENT_CONFIGS.OTHER.baseSpeed;
                 }

                 // Tambahkan sedikit keacakan pada kecepatan pengetikan karakter
                delay = delay * (1 + Math.random() * 0.1); // +/- 10% randomness

                // Tingkatkan indeks HTML dan Plain Text
                currentHtmlIndex++; // Maju satu karakter di HTML
                currentCharIndex++; // Maju satu karakter di plain text

                 // Atur innerHTML dengan potongan HTML yang sudah ditampilkan + karakter baru
                 const currentDisplayedHtml = fullHighlightedHtml.substring(0, currentHtmlIndex);
                 codeElement.innerHTML = currentDisplayedHtml + '<span class="cursor"></span>';
                 scrollToBottom(responseElement);

            }

            // Update progress bar berdasarkan plain text index
            updateProgressBar();

            // Panggil typeCodeCharacter berikutnya dengan delay yang ditentukan
            currentTypingTimeout = setTimeout(() => {
                typeCodeCharacter();
            }, delay);
        }


        // Helper untuk mendapatkan konfigurasi dari HLJS class (sudah ada)
        /*
        function getConfigFromHljsClass(hljsClass) {
            const configType = getConfigTypeFromHljsClass(hljsClass);
            return CODE_ELEMENT_CONFIGS[configType];
        }
        */


        // Fungsi escapeHTML (untuk fallback teks biasa)
         function escapeHTML(str) {
             return str.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;')
                       .replace(/"/g, '&quot;')
                       .replace(/'/g, '&#039;');
         }


        // Sesuaikan fungsi scroll untuk menggunakan responseElement
        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        function updateProgressBar() {
            if (totalCodeLength > 0) {
                // Progress berdasarkan indeks karakter pada kode asli (plain text)
                const progress = (currentCharIndex / totalCodeLength) * 100;
                progressBar.style.width = `${progress}%`;
            } else {
                 progressBar.style.width = '0%';
            }
        }

        // Fungsi untuk meng-toggle mode gelap website
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (isDarkMode) {
                localStorage.setItem('darkMode', 'enabled');
                updateDarkModeButtonIcon(); // Perbarui ikon
            } else {
                localStorage.setItem('darkMode', 'disabled');
                 updateDarkModeButtonIcon(); // Perbarui ikon
            }
             // Pemicu highlight ulang konten yang ada agar sesuai dengan mode terang/gelap tema HLJS
             // (Jika tema HLJS yang dipilih mendukung dark mode CSS)
             // Ini hanya berlaku jika typing tidak aktif atau dijeda
             if (originalCodeText) { // Hanya re-highlight jika ada kode yang pernah di-input
                 const selectedLanguage = languageSelectElement.value;
                 try {
                     let highlightedResult;
                      if (selectedLanguage === '') {
                           highlightedResult = hljs.highlightAuto(originalCodeText);
                      } else {
                           highlightedResult = hljs.highlight(originalCodeText, {language: selectedLanguage});
                      }
                     fullHighlightedHtml = highlightedResult.value; // Update full highlighted HTML

                      // Update class bahasa pada elemen code
                      codeElement.className = `hljs ${selectedLanguage === '' && highlightedResult.language ? 'language-' + highlightedResult.language : (selectedLanguage !== '' ? 'language-' + selectedLanguage : '')}`;


                     if (!isTyping && !isPaused) {
                          // Jika tidak aktif, tampilkan HTML penuh yang diperbarui
                          codeElement.innerHTML = fullHighlightedHtml + '<span class="cursor"></span>';
                           // Update index untuk tampilan penuh
                           currentHtmlIndex = fullHighlightedHtml.length;
                           currentCharIndex = originalCodeText.length;
                     } else if (isPaused) {
                         // Jika dijeda, tampilkan kembali potongan HTML yang sudah diketik (dari HTML baru)
                         const currentlyDisplayedHtmlSnippet = fullHighlightedHtml.substring(0, currentHtmlIndex);
                         codeElement.innerHTML = currentlyDisplayedHtmlSnippet + '<span class="cursor"></span>';
                     }
                      scrollToBottom(responseElement);

                 } catch(e) {
                     console.error("Highlight.js error during dark mode switch re-highlight:", e);
                      // Fallback jika re-highlight gagal saat mode gelap
                      // Biarkan tampilan teks biasa atau status terakhir
                      const plainTextContent = originalCodeText.substring(0, currentCharIndex);
                      codeElement.textContent = plainTextContent;
                      codeElement.className = ''; // Hapus class hljs
                      codeElement.innerHTML = codeElement.innerHTML + '<span class="cursor"></span>'; // Tambah kursor

                 }
             }
        }

         // Fungsi untuk memperbarui ikon dan teks tombol mode gelap (di dalam popup)
        function updateDarkModeButtonIcon() {
            const darkModeButton = document.querySelector('#config-popup .dark-mode-toggle button');
            if (darkModeButton) { /* Pastikan tombol ada sebelum memperbarui */
                if (document.body.classList.contains('dark-mode')) {
                    darkModeButton.innerHTML = '<i class="fas fa-sun"></i> Mode Terang'; // Indonesian
                } else {
                    darkModeButton.innerHTML = '<i class="fas fa-moon"></i> Mode Gelap'; // Indonesian
                }
            }
        }


        // Fungsi untuk meng-toggle visibilitas popup konfigurasi dan backdrop
        function toggleConfigPopup() {
            configPopup.classList.toggle('visible');
            modalBackdrop.classList.toggle('visible'); // Toggle visibilitas backdrop
             if (configPopup.classList.contains('visible')) {
                 populateCodeElementConfigPanel(); // Isi ulang konfigurasi saat dibuka
                 updateDarkModeButtonIcon(); // Perbarui ikon mode gelap di popup saat dibuka
             }
        }


        // --- Initial setup and Event Listeners ---

        // Isi dropdown dan terapkan preferensi saat DOM dimuat
        document.addEventListener('DOMContentLoaded', (event) => {
             // Pastikan Highlight.js sudah dimuat
             if (typeof hljs === 'undefined') {
                 console.error('Highlight.js belum dimuat. Pastikan script Highlight.js dimuat sebelum script ini.');
                 return;
             }

             populateLanguageSelect();
             populateThemeSelect(); // Isi dropdown tema syntax

             // Periksa preferensi mode gelap website yang tersimpan saat dimuat
             if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
             }
             // Perbarui ikon tombol mode gelap saat halaman dimuat
             updateDarkModeButtonIcon();

             // Terapkan tema HLJS default atau yang tersimpan saat dimuat
             const savedHljsThemeUrl = localStorage.getItem('selectedHljsThemeUrl');
             // Cari link tema HLJS utama
             let mainThemeLink = document.getElementById('hljs-theme-main');


             if (mainThemeLink) {
                 if (savedHljsThemeUrl) {
                     // Cari URL tema di daftar dan set dropdown
                     const themeOption = themeSelectElement.querySelector(`option[value="${savedHljsThemeUrl}"]`);
                     if (themeOption) {
                          themeSelectElement.value = savedHljsThemeUrl;
                          applySelectedHljsTheme(savedHljsThemeUrl); // Terapkan tema yang tersimpan
                     } else {
                         // Jika URL tema tersimpan tidak ada di daftar, fallback ke default
                          themeSelectElement.value = HLJS_THEMES[0].url;
                          applySelectedHljsTheme(HLJS_THEMES[0].url);
                     }
                 } else {
                     // Jika tidak ada tema tersimpan, terapkan tema default
                      themeSelectElement.value = HLJS_THEMES[0].url;
                      applySelectedHljsTheme(HLJS_THEMES[0].url);
                 }
             } else {
                 console.error("Tidak ditemukan link stylesheet Highlight.js dengan ID 'hljs-theme-main'. Tema tidak dapat diterapkan.");
             }


             // Sorot ulang kode awal jika ada (setelah tema diterapkan)
             // Ini akan menangani kasus jika ada kode statis di awal atau jika halaman direload saat dijeda
             // Gunakan textContent elemen code (jika ada kode statis) atau originalCodeText (jika dari reload saat dijeda)
             const textToHighlight = originalCodeText || codeElement.textContent.replace(/<span class="cursor"><\/span>/g, '');

             if (textToHighlight.trim() !== '') {
                 // Simpan teks awal sebagai originalCodeText jika belum ada
                  if (!originalCodeText) {
                      originalCodeText = textToHighlight;
                      totalCodeLength = originalCodeText.length;
                  }

                  // Terapkan bahasa yang tersimpan (atau auto-detect) pada konten statis awal
                  const selectedLanguage = localStorage.getItem('selectedLanguageId') || '';

                 try {
                     let highlightedResult;
                     if (selectedLanguage === '') {
                         highlightedResult = hljs.highlightAuto(originalCodeText);
                          // Update class bahasa yang terdeteksi pada elemen code
                         codeElement.className = `hljs ${highlightedResult.language ? 'language-' + highlightedResult.language : ''}`;
                     } else {
                          highlightedResult = hljs.highlight(originalCodeText, {language: selectedLanguage});
                           // Update class bahasa yang dipilih pada elemen code
                           codeElement.className = `hljs language-${selectedLanguage}`;
                     }
                     fullHighlightedHtml = highlightedResult.value; // Selalu simpan full highlighted HTML

                     if (!isTyping && !isPaused) {
                          // Jika tidak aktif, tampilkan HTML penuh yang diperbarui
                          codeElement.innerHTML = fullHighlightedHtml + '<span class="cursor"></span>';
                           // Update index untuk tampilan penuh
                           currentHtmlIndex = fullHighlightedHtml.length;
                           currentCharIndex = originalCodeText.length;
                           updateProgressBar();
                     } else if (isPaused) {
                         // Jika dijeda saat reload, tampilkan potongan HTML yang sesuai dengan currentHtmlIndex
                          const currentlyDisplayedHtmlSnippet = fullHighlightedHtml.substring(0, currentHtmlIndex);
                          codeElement.innerHTML = currentlyDisplayedHtmlSnippet + '<span class="cursor"></span>';
                           // currentCharIndex dan currentHtmlIndex seharusnya sudah terload dari state sebelumnya jika diimplementasikan.
                           // Untuk saat ini, diasumsikan state (currentCharIndex, currentHtmlIndex, isPaused) dipertahankan oleh browser saat reload jika sebelumnya dijeda.
                           updateProgressBar(); // Update progress based on saved currentCharIndex
                     }


                 } catch (e) {
                     console.error("Highlight.js error during initial static highlighting:", e);
                      // Fallback ke teks biasa jika gagal highlight statis
                      codeElement.innerHTML = textToHighlight + '<span class="cursor"></span>';
                      codeElement.className = ''; // Hapus class hljs jika fallback
                      fullHighlightedHtml = escapeHTML(textToHighlight); // Simpan teks biasa sebagai fallback HTML
                      currentHtmlIndex = fullHighlightedHtml.length; // Set HTML index to end for static content
                      currentCharIndex = originalCodeText.length; // Set plain text index to end for static content
                      updateProgressBar();
                 }
             }


        });


        // Tambahkan event listener untuk perubahan bahasa (berada di luar popup)
        languageSelectElement.addEventListener('change', function() {
             localStorage.setItem('selectedLanguageId', languageSelectElement.value); // Simpan preferensi bahasa

             // Jika sedang mengetik atau dijeda, re-highlight full text dengan bahasa baru dan lanjutkan
             if (originalCodeText) { // Hanya lakukan jika ada kode yang di-input
                  const selectedLanguage = languageSelectElement.value;
                  try {
                       let highlightResult;
                       if (selectedLanguage === '') {
                           highlightResult = hljs.highlightAuto(originalCodeText);
                           // Update class bahasa yang terdeteksi pada elemen code
                           codeElement.className = `hljs ${highlightResult.language ? 'language-' + highlightResult.language : ''}`;
                       } else {
                           highlightResult = hljs.highlight(originalCodeText, {language: selectedLanguage});
                            // Update class bahasa yang dipilih pada elemen code
                           codeElement.className = `hljs language-${selectedLanguage}`;
                       }
                       fullHighlightedHtml = highlightResult.value; // Update full highlighted HTML

                       if (isTyping) {
                           // Jika sedang mengetik, jeda dan kemudian resume dengan HTML baru
                           pauseTypingCode(); // Ini akan menyimpan currentCharIndex dan currentHtmlIndex
                           // resumeTypingCode akan dipanggil di bawah
                       }

                       // Tampilkan kembali potongan HTML yang sudah diketik dari HTML baru
                       const currentlyDisplayedHtmlSnippet = fullHighlightedHtml.substring(0, currentHtmlIndex);
                       codeElement.innerHTML = currentlyDisplayedHtmlSnippet + '<span class="cursor"></span>';
                        scrollToBottom(responseElement);


                       if (isPaused) {
                            // Jika sebelumnya dijeda, lanjutkan typing dari titik yang disimpan
                            resumeTypingCode();
                       } else if (!isTyping) {
                           // Jika tidak sedang mengetik dan tidak dijeda, dan ini bukan dari startTypingCode,
                           // maka kita hanya mengganti bahasa/tema untuk kode yang sudah selesai diketik.
                           // Pastikan tampilan akhir diperbarui.
                           if (currentCharIndex >= originalCodeText.length) {
                                codeElement.innerHTML = fullHighlightedHtml; // Tampilkan HTML penuh jika sudah selesai
                           }
                       }

                   } catch (e) {
                       console.error("Highlight.js error during language change re-highlight:", e);
                        // Handle fallback jika re-highlight gagal
                        // Biarkan tampilan teks biasa atau status terakhir
                       const plainTextContent = originalCodeText.substring(0, currentCharIndex);
                       codeElement.textContent = plainTextContent;
                       codeElement.className = ''; // Hapus class hljs
                       codeElement.innerHTML = codeElement.innerHTML + '<span class="cursor"></span>'; // Tambah kursor
                   }
             }
        });

        // Event listener untuk perubahan tema syntax sudah ada di atas (applySelectedHljsTheme)


         // Tutup popup jika diklik di luar (opsional, menggunakan klik backdrop)
        modalBackdrop.addEventListener('click', function() {
             if (configPopup.classList.contains('visible')) {
                 toggleConfigPopup(); // Tutup popup saat backdrop diklik
             }
        });

        // Hapus elemen #language-display yang tidak lagi digunakan
        const languageDisplayElement = document.getElementById('language-display');
        if (languageDisplayElement) {
            languageDisplayElement.remove();
        }


    </script>
</body>
</html>